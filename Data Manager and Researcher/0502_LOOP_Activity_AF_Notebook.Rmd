---
title: "LOOP - Activity and AF"
output:
  html_notebook:
    toc: yes
  pdf_document:
    highlight: tango
    toc: yes
  editor_options: 
    chunk_output_type: inline
  chunk_output_type: console
---

This notebook is for working with the research question "Is activity and AF related?" 

```{r Load Libraries}
rm(list=ls())
library(RMariaDB)
library(tidyverse)
library(lubridate) # Easier to work with dates and times
library(gridExtra)
library(data.table)
library(RcppRoll)
library(zoo)
library(ISLR)
library(eeptools)
library(getPass)
library("cowplot")
source("C:/Users/mathi/Documents/GitHub/Rigshospitalet-Data-Analysis/LOOP_preprocessing.R")

```

Next up is to remove falsely detected AF-events, by using a file created by SÃ¸ren, after going through the Ids one by one and annotating them as TRUE or FALSE.

```{r Get true AF labels from Database}

my.password <- getPass()

con <- dbConnect(RMariaDB::MariaDB(), 
                 user=XXX ,
                 password=XXX, 
                 dbname=XXX, 
                 host=XXX, 
                 port=XXX)
tableslist<-dbListTables(con) 

afib<-as.tbl(as.data.frame(tbl(con, "view_afib"))) %>% 
  group_by(studyid) %>% 
  arrange(event_date) %>%  filter(row_number()==1) %>% 
  select(studyid, afib_event_date=event_date, symptomatic, ilr_diagnosed)

age_gender<-as.tbl(as.data.frame(tbl(con, "view_subjects"))) %>%
  mutate(age = as.double(floor((randomization_date - date_of_birth)/365))) %>%
  select(studyid,gender,age,date_of_birth)

screening_info <- tibble::as_tibble(as.data.frame(tbl(con, "view_screening"))) %>% # Extract hypertension info
  select(studyid,hypertension,diabetes,stroke,heart_failure,oac_candidate)

medhx <- tibble::as_tibble(as.data.frame(tbl(con, "view_medhx"))) %>% # Extract Alchohol and smoking info
  mutate(tia_or_stroke = if_else(tia + stroke >0,1,0)) %>%
  select(studyid,alcohol_consumption,smoker_status,smoking_pack_years,tia_or_stroke,pad_untreated,cabg,valvular_disease)

physical<-as.tbl(as.data.frame(tbl(con, "view_physical"))) %>%
  group_by(studyid) %>%
  drop_na() %>%
  summarise(bas_weight = first(weight),
            bas_height = first(height)) %>%
  select(studyid,bas_height,bas_weight)

baseline_info <- left_join(age_gender,physical) %>%
  left_join(screening_info) %>%
  left_join(medhx) %>%
  mutate(CHADVASC = if_else(age>74,2,1) + if_else(gender == "Female",1,0) + hypertension + stroke*2 + diabetes) # TODO: Add vascular risk factor

rm(age_gender,physical,screening_info,my.password)
  
dbDisconnect(con)
rm(con)
```
Now we can remove the false AF events:

```{r Remove false AFs - EpisodeDur & Compass}
serialn<-read.csv2("C:/Users/mathi/Desktop/LOOP_data/serialn_studyid.csv")

Preprocess_list <- Remove_False_AF_events(serialn,"C:/Users/mathi/Desktop/LOOP_data/EpisodeDurations_LOOP_FULL.csv","C:/Users/mathi/Desktop/LOOP_data/Compass_LOOP_FULL.csv")
episodestrue_ED = Preprocess_list[[1]]
episodestrue_C = Preprocess_list[[2]]
rm(Preprocess_list)

getSeason <- function(DATES) {
    WS <- as.Date("2012-12-21", format = "%Y-%m-%d") # Winter Solstice
    SE <- as.Date("2012-3-20",  format = "%Y-%m-%d") # Spring Equinox
    SS <- as.Date("2012-6-21",  format = "%Y-%m-%d") # Summer Solstice
    FE <- as.Date("2012-9-23",  format = "%Y-%m-%d") # Fall Equinox

    # Convert dates from any year to 2012 dates
    d <- as.Date(strftime(DATES, format="2012-%m-%d"))

    ifelse (d >= WS | d < SE, "Winter",
      ifelse (d >= SE & d < SS, "Spring",
        ifelse (d >= SS & d < FE, "Summer", "Fall")))
}
```



```{r Preprocessing af data}

#### SEE VARIABLE FOR CHOSING AF DEFINITION in CODE"

### Create DF with daily ids if specific event occured
AF_Dur_thr_df <- episodestrue_ED %>%
  mutate(Min6min = if_else(DurationInSeconds >= 60*6,1,0),
         Min60min = if_else(DurationInSeconds >= 60*60,1,0),
         Min330min = if_else(DurationInSeconds >= 60*60*5.5,1,0)) %>%
  group_by(studyid,episodestartdate) %>%
  summarise(Min6min = sum(Min6min),        # For removing doubles
            Min60min = sum(Min60min),
            Min330min = sum(Min330min),
            #DurationInSeconds = DurationInSeconds,
            AF_id = if_else(Min60min>0,1,0)) %>% ### VARIABLE FOR CHOSING AF DEFINITION
  filter(AF_id==1) ### HANDLE FOR Sensitivity Analysis

ActivityAF_DF <- left_join(episodestrue_C,AF_Dur_thr_df)
ActivityAF_DF[c("Min6min","Min60min","Min330min")][is.na(ActivityAF_DF[c("Min6min","Min60min","Min330min")])] <- 0

# Add BMI, Age and Gender
ActivityAF_DF <- left_join(ActivityAF_DF,baseline_info) %>%
  mutate(bas_bmi = bas_weight/(bas_height/100)^2,
         age = floor((episodestartdate - date_of_birth)/365)) %>%
  group_by(studyid) %>%
  mutate(w_point = c(0),
         w_pre = c(0),
         w_dur = c(0),
         w_delta = c(0), # Difference in activity [Hours]
         events6min = cumsum(Min6min),
         events60min = cumsum(Min60min),
         events330min = cumsum(Min330min),
         meanAct = mean(ActivitiesOfDlyLiving,na.rm = TRUE),
         meanAct_g = cut(meanAct,breaks = c(-Inf,80,142,Inf)),
         AF_id = if_else(is.na(AF_id),0,AF_id)) %>%
  select(everything(),-serialn,-TrendDateTime,-DayHeartRate,-HeartRateVariability,
         -MaxVRateDurAFAT,-MeanVRateDurAFAT,-NightHeartRate,-SymptomAnnotation,
         -bas_weight,-bas_height,-TotAFSeconds) %>%
  filter(!is.na(ActivitiesOfDlyLiving),!is.na(studyid))

#ActivityAF_DF$DurationInSeconds[is.na(ActivityAF_DF$DurationInSeconds)] <- 0 # Change NA's to 0

ActivityAF_DF <- ActivityAF_DF %>% # Add season to data
  mutate(season = getSeason(episodestartdate))

```

```{r Logistic Regression of Windowed activity - Model 2 (Final)}

### Parameter Estimations:

# OPTION 1: Activity window:
w_dur_l_v <-c(7) #  c(2,7) # Length of Window 2
w_dur_lag <- 1

w_pre_l_v <- c(100)  #c(40,100,150,200) # Length of Window 1 [100]
w_pre_lag <- 8

# OPTION 2: Use only participants WITH at least one AF event of at least 60min
exclude_noaf_ids <- 0 # 1 = yes, 0 = no

int_dept = 1 # 1 = calculate conf-int and all, 0 = dont

# OPTION 3: Activity Profiles thresholds
#avg_act_df <- Log_Res_DF %>% group_by(studyid) %>% summarise(Avg_Act = mean(ActivitiesOfDlyLiving)) %>% filter(!is.na(Avg_Act))
#quantile(avg_act_df$Avg_Act,c(0.33,0.66))

Act_groups_th <- c(-Inf,81,142,Inf) # Use quantiles <--(see above) -- OLD: c(-Inf,60,147,Inf)
Log_Res_DF <- ActivityAF_DF %>%
  mutate(Act_group = cut(meanAct, breaks = Act_groups_th)) %>%
  filter(!is.na(studyid))

### MODEL 1: Build and run model (Using Windowed Data)
Res_DF <- data.frame(Estimate = double(0),
                       std = double(0),
                      z = double(0),
                       Prz = double(0),
                      act_g = character(0))

Res_df_dept <- data.frame(act_g = character(0),
                       Count = double(0),
                      Percent = double(0),
                       Point.Estimate = double(0),
                      Low = double(0),
                      High = double(0),
                      P.Value = double(0),
                      w_pre_l = double(0),
                      w_dur_l = double(0))

act_groups <- c(levels(Log_Res_DF$Act_group),"(-Inf, Inf)")

for (j in w_dur_l_v) { # LOOP for changing w_dur window
  for(k in w_pre_l_v) {
    w_dur_l = j
    w_pre_l = k
    print(w_dur_l)
    Log_Res_DF <- Log_Res_DF %>%
      select(everything(),-w_dur,-w_delta) %>%
      mutate(w_dur = lag(rollapply(ActivitiesOfDlyLiving,w_dur_l,mean,fill= NA,align = "right"),w_dur_lag),
             w_pre = lag(rollapply(ActivitiesOfDlyLiving,w_pre_l,mean,fill= NA,align = "right"),w_pre_lag),
          # w_delta = (w_dur - w_pre)/60)   # Positive delta -> increase in activity
            w_delta = (w_pre - w_dur)/60)   # Positive delta -> decrease in activity

    for (i in 1:length(act_groups)) { # LOOP for activity-group stratification
      print(act_groups[i])
      if(i < 4) {
        DF_seg <- Log_Res_DF %>%
      filter(Act_group == act_groups[i])
      } else {
        DF_seg <- Log_Res_DF
      }
      Res.model <- glm(AF_id ~ w_delta + events60min + season + age + gender + diabetes + hypertension + tia_or_stroke + heart_failure,
                       data = DF_seg, family = "binomial")
      Res_par <- summary(Res.model)$coefficients %>%
      as.data.frame() %>%
      rownames_to_column() %>%
      mutate(act_g = act_groups[i],
             w_dur_l = w_dur_l,
             w_dur_lag = w_dur_lag,
             w_pre_l = w_pre_l,
             w_pre_lag = w_pre_lag,
             exclude_noaf_ids = exclude_noaf_ids,
             participants = length(unique(DF_seg$studyid)))
    Res_DF <- rbind(Res_DF,Res_par)
      if(int_dept == 1) {
        Conf_int_v <- exp(confint(Res.model))
        new_info <- data.frame(act_g = act_groups[i],
                           Count = length(unique(DF_seg$studyid)),
                          Percent = round((length(unique(DF_seg$studyid))/length(unique(Log_Res_DF$studyid)))*100,1),
                           Point.Estimate = exp(Res_par[2,2]) ,
                          Low = Conf_int_v["w_delta",1],
                          High = Conf_int_v["w_delta",2],
                          P.Value = round(Res_par[2,5],3),
                          w_pre_l = w_pre_l,
                          w_dur_l = w_dur_l)
        Res_df_dept <- rbind(Res_df_dept,new_info)
      }
    }
  }
}
Res_DF_wd <- Res_DF %>%
  select(everything(),-contains("Std"),contains("z"),contains("Pr")) %>%
  filter(rowname == "w_delta") %>%
  mutate(sign_05 = if_else(`Pr(>|z|)`<0.05,"yes","no"))
#saveRDS(Res_df_dept, file="Res_df_dept_all_decrease_60min_multi.Rda")
#saveRDS(Res_DF_wd, file="Res_df_wd_all_decrease_60min_multi.Rda")
#saveRDS(Res_DF, file="Res_df_all_decrease.Rda")

#write.csv2(Res_DF_wd,file="C:/Rigshospitalet_Drive/Forskning/Activity and AF/Figures/Res_DF_wd.csv", row.names = F)

```

##### FOR ARTICLE #####

```{r PAPER-PLOT (1): Activity pattern stratifying by activity group}
library(data.table)
library(ggpubr)
library(scales) ## perc
library(PMCMR) #posthoc Kruskal Wallis
f_path = "C:/Rigshospitalet_Drive/Forskning/Activity and AF/Figures/"

### PLOT for Activity results section
ref_days = 32
smooth_par = 32 # parameter for smoothing out the average movement
w_dur_l = 7
w_pre_l = 100
w_dur_lead = 0; w_pre_lag = 8;
baseline_date = "2015-06-01"  #"2014-09-01"
end_date = "2019-06-01"       # Important! start and end must be same month/diff year

Ref_act_df <- ActivityAF_DF %>%
  filter(episodestartdate > baseline_date) %>%
  summarise(ref_act = median(ActivitiesOfDlyLiving),
            first_day = min(episodestartdate)) %>%
  mutate(act_cat = cut(ref_act, breaks = c(-Inf,80,142,Inf))) %>% filter(!is.na(act_cat))
  
DF_for_plot_pre <- ActivityAF_DF %>% group_by(studyid) %>% filter(episodestartdate > baseline_date, episodestartdate<end_date) %>%
  left_join(Ref_act_df) %>%
   mutate(w_dur = lead(rollapply(ActivitiesOfDlyLiving,w_dur_l,mean,fill= NA,align = "right"),w_dur_lead),
          w_pre = lag(rollapply(ActivitiesOfDlyLiving,w_pre_l,mean,fill= NA,align = "right"),w_pre_lag),
          w_delta = (w_pre - w_dur)/60) %>%  # Positive delta -> decrease in activity
  filter(!is.na(act_cat))

DF_for_plot <- DF_for_plot_pre %>% 
  group_by(episodestartdate,act_cat) %>%
  summarise(average_act = mean(ActivitiesOfDlyLiving)/60,
            ids = n(),
            AF_ids_p = sum(if_else(AF_id >0,1,0))/n(),
            Dchange = sum(w_delta>1,na.rm=T)/ids) %>%
  group_by(act_cat) %>%
  mutate(average_act_roll = rollapply(average_act,smooth_par,mean,fill= NA,align = "right",na.rm = TRUE),
         AF_ids_roll = rollapply(AF_ids_p,smooth_par,mean,fill= NA,align = "right",na.rm = TRUE),
         days_into_study = row_number())

p1 <- ggplot(DF_for_plot,aes(x = episodestartdate, y = average_act, fill = act_cat, colour = act_cat)) + geom_point(alpha = 0.4) + theme_bw() +
  #facet_grid(rows = vars(act_cat)) +
  geom_smooth(method = "lm", show.legend=F,colour = "black",linetype = "dashed") +
  xlab("Year") + ylab("Avg. activity [Hours]") +
  theme(legend.position = "none") + 
   stat_cor(aes(x=as.Date("2018-01-01"), y=4))
## https://rpkgs.datanovia.com/ggpubr/reference/stat_regline_equation.html

p2 <- ggplot(DF_for_plot_pre,aes(x = ActivitiesOfDlyLiving/60 )) + geom_histogram() + theme_bw() +
  xlim(c(0,10)) +
  xlab("Activity [Hours]") + ylab("Days") +
  theme(legend.position = "none")

p3 <- ggplot(DF_for_plot_pre,aes(x = w_delta )) + geom_histogram(binwidth = 0.1) + theme_bw() +
  #facet_grid(rows = vars(act_cat)) +
  xlab("Delta Activity [Hours]") + ylab("Days") +
  xlim(c(-3,3)) +
  theme(legend.position = "none")

ggarrange(p2,p3,
          ncol = 2, 
          labels = c("A", "B"))
#ggsave(paste(f_path,"Overview of activity.png_6min",sep = ""), width=6, height=3, dpi=600)

# Equation for trend ------------------------
### Remove or change the "filter" option to group or not, or change groups

#DF_for_plot <- DF_for_plot_pre %>% group_by(studyid) %>%
  #filter(act_cat == "(-Inf,80]") %>% # (-Inf,80]   (80,142] (142, Inf]
 # group_by(episodestartdate) %>%
  #summarise(average_act = mean(ActivitiesOfDlyLiving)/60)

#ggplot(DF_for_plot,aes(x = episodestartdate, y = average_act)) + geom_point(alpha = 0.4) + theme_bw() +
  #facet_grid(rows = vars(act_cat)) +
#  geom_smooth(method = "lm", show.legend=F,colour = "black",linetype = "dashed") +
#  xlab("Year") + ylab("Avg. activity [Hours]") +
#  theme(legend.position = "none") + 
#   stat_cor(aes(x=as.Date("2018-01-01"), y=4))
## https://rpkgs.datanovia.com/ggpubr/reference/stat_regline_equation.html


#Linear_analysis <- DF_for_plot_pre %>%  group_by(studyid) %>%
#  filter(act_cat == "(-Inf,80]") %>%
#  group_by(episodestartdate) %>%
#  summarise(Activity_h = mean(ActivitiesOfDlyLiving)/60) %>%
#  mutate(years = row_number()/(365))
#row_id.lm <- lm(Activity_h ~ years, data=Linear_analysis)
#summary(row_id.lm)


```

```{r PAPER-PLOT (2): AF in the dataset stratifying by activity group}

smooth_f = 7
DF_for_plot_smth <- DF_for_plot %>%
  mutate(AF_ids_p = rollapply(AF_ids_p,smooth_f,mean,fill= NA,align = "right"),
         day_id = row_number())

### PLOT for AF results seciton
p11 <- ggplot(DF_for_plot_smth,aes(x = episodestartdate, y = AF_ids_p, fill = act_cat, colour = act_cat)) + geom_point(alpha = 0.5) + theme_bw() +
  #facet_grid(rows = vars(act_cat)) +
  #geom_smooth(method = "lm", formula = y ~ splines::bs(x, 3), show.legend=F,colour = "black",linetype = "dashed") +
  xlab("Year") + ylab("Fraction in AF") +
  ylim(c(0,0.025)) +
  theme(legend.position = "none")


p22 <- ggplot(DF_for_plot,aes(x = act_cat,y = AF_ids_p, fill = act_cat)) + geom_boxplot(show.legend = F) + theme_bw() +
  ylim(c(0,0.05)) +
   scale_x_discrete(breaks=levels(DF_for_plot$act_cat),
                    labels = c(expression("Act"["low"]),expression("Act"["mid"]),expression("Act"["high"]))) +
  annotate("text", x = 3, y=0.04, label = "P < 0.01") +
  annotate("rect", xmin = 2.5, xmax = 3.5, ymin = 0.0375, ymax = 0.0425,
  alpha = .2) +
  xlab("") + ylab("Fraction in AF")


ggarrange(p11,p22,
          ncol = 2, 
          labels = c("A", "B"))

kruskal.test(AF_ids_p ~ act_cat, data = DF_for_plot)
attach(DF_for_plot)
posthoc.kruskal.nemenyi.test(x = AF_ids_p, g=act_cat, dist="Tukey")
detach(DF_for_plot)
summary(LM_model_L <- glm(Min60min ~ meanAct_g + age + gender + diabetes + tia_or_stroke + heart_failure
                 , data = ActivityAF_DF))

summary(LM_model_L <- glm(AF_ids_p ~ day_id
                 , data = DF_for_plot_smth))

# Model for checking association between average activity and AF_id
m3<- glm(AF_id ~ meanAct + events60min + season + age + gender + diabetes + hypertension + tia_or_stroke + heart_failure,
                       data = Log_Res_table, family = "binomial")
summary(m3)

ggsave(paste(f_path,"AF events in the dataset.png",sep = ""), width=6, height=3, dpi=600)

```

```{r PAPER-PLOT (3): Activity on AF vs non-AF days}

Plot_3_df_A <- ActivityAF_DF %>%
  group_by(studyid,AF_id) %>%
  mutate(Activity_pattern = ActivitiesOfDlyLiving) %>%
  summarise(avg_act_h = mean(Activity_pattern,na.rm = T)/60,
            age = first(age),
            gender = unique(gender),
            diabetes = unique(diabetes),
            hypertension = unique(hypertension),
            tia_or_stroke = unique(tia_or_stroke)) %>%
  mutate(AF_id = as.factor(AF_id)) %>%
  filter(!is.na(avg_act_h)) %>% # Remove those who do not have AF events
  filter(n() > 1) %>% # Same
  ungroup()  
levels(Plot_3_df_A$AF_id) <- c("Days with AF","Days without AF")

ggplot(Plot_3_df_A,aes(x = AF_id, y = avg_act_h,group = studyid)) +
  geom_line(show.legend = F,alpha=0.25, color = "red") +theme_bw() +
  scale_fill_manual(values=c("#F8766D","#00BFC4")) +
  annotate("text", x = 1.5, y=6.65, label = "P = 0.02") +
  annotate("rect", xmin = 1.25, xmax = 1.75, ymin = 6.25, ymax = 7,
  alpha = .2) +
  ylab("Average Activity [Hour]") + xlab("")
#ggsave(paste(f_path,"AF activity difference.png",sep = ""), width=5, height=3, dpi=500)

### Statistical test of difference using wilcox test
t.test(Plot_3_df_A %>% filter(AF_id=="Days without AF") %>% select(avg_act_h) %>% pull,
       Plot_3_df_A %>% filter(AF_id=="Days with AF") %>% select(avg_act_h) %>% pull, paired = TRUE, alternative = "two.sided")
 
summary(lm(avg_act_h ~ AF_id #+ age + diabetes + hypertension + tia_or_stroke
           , data = Plot_3_df_A))

### Association between AF_id and activity
reg_df <- ActivityAF_DF %>% mutate(ActivitiesOfDlyLiving_h = ActivitiesOfDlyLiving/60)
summary(glm(AF_id ~ ActivitiesOfDlyLiving_h + events60min + age + heart_failure +
             diabetes + hypertension + tia_or_stroke
           , data = reg_df))


```

```{r PAPER-PLOT (5): Forest plot}
## FROM "https://www.r-bloggers.com/2016/07/forest-plot-with-horizontal-bands/"
library(forestplot)
f_path = "C:/Rigshospitalet_Drive/Forskning/Activity and AF/Figures/"
#Res_df_dept <- readRDS(file="Res_df_dept_age_diab_hyp_28_10_2020.Rda") 
Res_df_dept <- readRDS(file="Res_df_dept_all_decrease_60min.Rda") # Load from github
#readRDS(file="Res_df_dept_28_10_2020.Rda")
Res_DF_wd <-readRDS(file="Res_df_dept_all_decrease_60min.Rda")  #readRDS(file="Res_DF_wd_28_10_2020.Rda")

Res_df_dept$P.Value <- round(Res_df_dept$P.Value,digits = 2)

data <- Res_df_dept %>% filter(w_dur_l == 7,w_pre_l == 100)  %>%
  mutate(P.Value = as.character(if_else(P.Value<0.01,0.01,P.Value))) %>%
  mutate(P.Value = if_else(as.double(P.Value)==0.01,"<0.01",P.Value ))
data$act_g <- c("Low","Mid","High","All")


## Labels defining subgroups are a little indented!
subgps <- c(1,2,3,4)
data$Variable[subgps] <- paste("  ",data$Variable[subgps]) 
 
## Combine the count and percent column
np <- ifelse(!is.na(data$Count), paste(data$Count," (",data$Percent,")",sep=""), NA)
 
## The rest of the columns in the table. 
tabletext <- cbind(c("Subgroup","\n",data$act_g), 
                    c("No. of Individuals (%)","\n",np), 
                    #c("4-Yr Cum. Event Rate\n PCI","\n",data$PCI.Group), 
                    #c("4-Yr Cum. Event Rate\n Medical Therapy","\n",data$Medical.Therapy.Group), 
                    c("P Value","\n",data$P.Value))

#png(file.path(workdir,"Figures\\Forestplot.png"),width=960, height=640)
forestplot(labeltext=tabletext, graph.pos=3, 
           mean=c(NA,NA,data$Point.Estimate), 
           lower=c(NA,NA,data$Low), upper=c(NA,NA,data$High),
           title="Odds Ratio",
           xlab="     Odds ratio for an AF event related to a sudden \n  decrease in activity        ",
           #hrzl_lines=list("1" = gpar(lwd=10, col="#99999922"), 
            #              "2" = gpar(lwd=44, lineend="butt", columns=c(2:4), col="#99999922"),
                          #"15" = gpar(lwd=60, lineend="butt", columns=c(2:6), col="#99999922"),
                          #"23" = gpar(lwd=60, lineend="butt", columns=c(2:6), col="#99999922"),
            #              "3" = gpar(lwd=60, lineend="butt", columns=c(1:4), col="#99999922")),
           #txt_gp=fpTxtGp(label=gpar(cex=1.25),
          #                    ticks=gpar(cex=1.1),
          #                    xlab=gpar(cex = 1.2),
           #                   title=gpar(cex = 1.2)),
           col=fpColors(box="black", lines="royalblue", zero = "gray50"),
           zero=1, cex=0.9, lineheight = "auto", boxsize=0.3, colgap=unit(6,"mm"),
           lwd.ci=2, ci.vertices=TRUE, ci.vertices.height = 0.4)
#ggsave(paste(f_path,"Forest plot 7 100.png",sep = ""), width=6, height=4)  Does not work - use right-click-save

```

```{r PAPER-TABLE (2)}
library(Publish)

# CREATE TABLE #
table_2_df <- ActivityAF_DF %>% group_by(studyid) %>%
  summarise(meanAct_g = unique(meanAct_g),
            meanAct = mean(meanAct),
            age = last(age),
            gender = unique(gender),
            diabetes = unique(diabetes),
            tia_or_stroke = unique(tia_or_stroke),
            heart_failure = unique(heart_failure),
            hypertension = unique(hypertension)) %>%
  mutate(age = cut(age,breaks = c("-Inf","75","Inf"), labels = c("<75",">=75"))) %>%
  filter(!is.na(studyid))

levels(table_2_df$meanAct_g) <- c('<80', '80-142','>142')

A_age <- table_2_df %>% group_by(age) %>%
  summarise(m = median(meanAct),q1 = quantile(meanAct,0.3),q2 = quantile(meanAct,0.6))
A_gender <- table_2_df %>% group_by(gender) %>%
  summarise(m = median(meanAct),q1 = quantile(meanAct,0.3),q2 = quantile(meanAct,0.6))
A_diabetes <- table_2_df %>% group_by(diabetes) %>%
  summarise(m = median(meanAct),q1 = quantile(meanAct,0.3),q2 = quantile(meanAct,0.6))
A_tos <- table_2_df %>% group_by(tia_or_stroke) %>%
  summarise(m = median(meanAct),q1 = quantile(meanAct,0.3),q2 = quantile(meanAct,0.6))
A_hf <- table_2_df %>% group_by(heart_failure) %>%
  summarise(m = median(meanAct),q1 = quantile(meanAct,0.3),q2 = quantile(meanAct,0.6))
A_hyp <- table_2_df %>% group_by(hypertension) %>%
  summarise(m = median(meanAct),q1 = quantile(meanAct,0.3),q2 = quantile(meanAct,0.6))

A_tos <- A_tos[c(2,1),]
A_hyp <- A_hyp[c(2,1),]


act_info <- rbind(A_age[,c(2,3,4)],A_gender[,c(2,3,4)],
                  A_tos[,c(2,3,4)],A_diabetes[,c(2,3,4)],
                  A_hyp[,c(2,3,4)],A_hf[,c(2,3,4)]) %>%
  round(digits = 0) %>%
  mutate(all_info = paste(q1, q2, sep = ",")) %>%
  mutate(all_info = paste(m," (",all_info,")",sep = "")) %>%
  select(all_info) %>%
  setDT()

t2<-univariateTable(meanAct_g ~ age + gender + tia_or_stroke + diabetes + hypertension +heart_failure
                    ,data=table_2_df, n="inNames", na.rm=T)

t2edit<-summary(t2, drop.reference=F,"gender"="Male sex [%]", "age"="Age, years [%]", "hypertension"="Hypertension [%]", "diabetes"="Diabetes", "heart_failure"="Heart failure", "tia_or_stroke"="Previous stroke or TIA")

t2edit <- cbind(t2edit,act_info)
t2edit
write.csv2(t2edit,file="C:/Rigshospitalet_Drive/Forskning/Activity and AF/Figures/t2edit.csv", row.names = F)
```

```{r PAPER-TABLE (3)}
# load package
library(sjPlot)
library(sjmisc)
library(sjlabelled)
# https://cran.r-project.org/web/packages/sjPlot/vignettes/tab_model_estimates.html

w_dur_lag = 1
w_pre_lag = 8
w_dur_l = 7
w_pre_l = 100

Log_Res_table <- ActivityAF_DF %>%
      select(everything(),-w_dur,-w_delta) %>%
      mutate(meanAct = meanAct/60, #Change from minutes to hours
             w_dur = lag(rollapply(ActivitiesOfDlyLiving,w_dur_l,mean,fill= NA,align = "right"),w_dur_lag),
             w_pre = lag(rollapply(ActivitiesOfDlyLiving,w_pre_l,mean,fill= NA,align = "right"),w_pre_lag),
            w_delta = (w_pre - w_dur)/60)   # Positive delta -> decrease in activity

#m1<- glm(AF_id ~ w_delta + events60min,
#                       data = Log_Res_table, family = "binomial")

#m2<- glm(AF_id ~ w_delta + events60min + season + age + gender,
#                       data = Log_Res_table, family = "binomial")

m3<- glm(AF_id ~ w_delta + meanAct + events60min + season + age + gender + diabetes + hypertension + tia_or_stroke + heart_failure,
                       data = Log_Res_table, family = "binomial")

tab_model(m1,
          pred.labels = c("Intercept", "DActivity","spring","summer","winther",
                  "Age [years]", "Gender [Male]", "Hypertension", "Diabetes", "TIA or Stroke","heart_failure"),
  dv.labels = c("M1"),
  string.est = "Est",
  string.pred = "Coeffcient",
  string.ci = "CI (95%)",
  string.p = "P"
)


```

```{r : PAPER-PLOT (4?) - Finding graphical example of model}
library(data.table)
library(ggpubr)
library(scales) ## perc

f_path = "C:/Rigshospitalet_Drive/Forskning/Activity and AF/Figures/"
w_dur_lag = 1; w_pre_lag = 7 + w_dur_lag; w_dur_l = 7; w_pre_l = 100

Log_Res_table <- ActivityAF_DF %>%
      select(everything(),-w_dur,-w_delta) %>%
      mutate(w_dur = lag(rollapply(ActivitiesOfDlyLiving,w_dur_l,mean,fill= NA,align = "right"),w_dur_lag),
             w_pre = lag(rollapply(ActivitiesOfDlyLiving,w_pre_l,mean,fill= NA,align = "right"),w_pre_lag),
             w_pre_sd = lag(rollapply(ActivitiesOfDlyLiving,w_pre_l,sd,fill= NA,align = "right"),w_pre_lag),
             w_pre_af_sum = lag(rollapply(Min60min,w_pre_l,sum,fill= NA,align = "right"),w_pre_lag),
             w_dur_af_sum = lag(rollapply(Min60min,w_dur_l,sum,fill= NA,align = "right"),w_pre_lag),
            w_delta = (w_pre - w_dur)/60)   # Positive delta -> decrease in activity

G_df <- Log_Res_table %>% group_by(studyid) %>%
  filter(sum(Min60min)>1,!is.na(w_delta)) %>%
  filter(w_pre_af_sum < 10 & w_dur_af_sum == 1 & w_delta > 1) %>%
  filter(Min60min == 1)

i = 5 # 5 is ok?
Graph_window <- Log_Res_table %>% group_by(studyid) %>%
  filter(studyid == G_df[i,"studyid"]) %>%
  filter(episodestartdate < G_df[i,"episodestartdate"]+1,
         episodestartdate > G_df[i,"episodestartdate"]-w_pre_l-w_pre_lag) %>%
  select(episodestartdate,w_pre,w_dur,w_delta,ActivitiesOfDlyLiving,Min60min) %>%
  mutate(window_id = row_number(),
         window_id = cut(window_id,
                         breaks = c(-Inf,w_pre_l,w_pre_l+w_dur_l,Inf)),
         outcome_point = 0)
Graph_window[nrow(Graph_window),"outcome_point"] <- 1

p1 <- ggplot(Graph_window,aes(x = episodestartdate,y = ActivitiesOfDlyLiving/60, color = as.factor(window_id), shape = as.factor(outcome_point))) +
  geom_point(aes(alpha = 1), size = c(2)) + theme_bw() +
  scale_size_manual(values=c(4)) +
  scale_shape_manual(values=c(16, 17, 18))+
  scale_color_manual(values = c("red","green","blue")) +
  theme(legend.position = "none") +
  annotate("text", x = as.Date("2018-01-02"), y=2.1, label = "AF") +
  ylim(c(0,4.5)) +
  xlab("Date") + ylab("Daily PA")

p2 <- ggplot(Graph_window,aes(x = episodestartdate,y = w_delta, color = as.factor(outcome_point), shape = as.factor(outcome_point))) +
  geom_point(aes(alpha = 1), size = c(2)) + theme_bw() +
  scale_size_manual(values=c(1,3,7)) +
  scale_shape_manual(values=c(16, 17, 18))+
  scale_color_manual(values = c("black","blue")) +
  scale_y_reverse() +
  ylim(c(1.5,-0.6)) +
  theme(legend.position = "none") +
  annotate("text", x = as.Date("2018-01-02"), y=0.8, label = "AF") +
  xlab("Date") + ylab("Delta PA")

ggarrange(p1,p2,
          nrow = 2, 
          labels = c("A", "B"))

# IMG 1: i = 5, and G_df is from +1 to -w_pre_l-w_pre_lag AND filter(w_pre_af_sum < 10 & w_dur_af_sum == 1 & w_delta > 1)

#ggsave(paste(f_path,"AF detection_Graphical Example 1.png",sep = ""), width=6, height=3, dpi=600)

### TEMP Test for dual episodestart dates...
#test <- ActivityAF_DF %>% group_by(studyid) %>% summarise(same_days = length(unique(episodestartdate))-length(episodestartdate))


```



```{r : TEMP - test of code }

ggplot(Graph_window,aes(x = episodestartdate,y = ActivitiesOfDlyLiving/60, color = as.factor(window_id), shape = as.factor(outcome_point))) +
  geom_point(aes(alpha = 1), size = c(2)) + theme_bw() +
  scale_size_manual(values=c(4)) +
  scale_shape_manual(values=c(16, 17, 18))+
  scale_color_manual(values = c("red","green","blue")) +
  theme(legend.position = "none") +
  ylim(c(0,4.5)) +
  annotate("text", x = as.Date("2018-01-01"), y=1.75, label = "AF") +
  xlab("Date") + ylab("Daily PA")

```



```{r Plots: Movement & Delta Movement}

ActivityAF_DF %>%
  group_by(studyid) %>%
  summarise(avg_act = mean(ActivitiesOfDlyLiving)) %>%
  ggplot(aes(x = avg_act)) + geom_histogram(bins = 50)

w_dur_l = c(7); w_dur_lead = c(0)
w_pre_l = c(70); w_pre_lag = c(7)
plot_df <- ActivityAF_DF %>%
  mutate(w_dur = lead(rollapply(ActivitiesOfDlyLiving,w_dur_l,mean,fill= NA,align = "right"),w_dur_lead),
         w_pre = lag(rollapply(ActivitiesOfDlyLiving,w_pre_l,mean,fill= NA,align = "right"),w_pre_lag),
         w_delta = (w_dur - w_pre)/60,
         w_delta_p = (w_dur/w_pre-1)*100) %>%
  filter(!is.na(w_delta), !w_pre == 0, !w_dur == 0)

ggplot(plot_df, aes(x = episodestartdate, y = w_delta_p)) + geom_point()

plot_df_2 <- plot_df %>% filter(!is.na(w_delta)) %>% group_by(episodestartdate) %>%
  mutate(#move_cat = cut(w_delta, breaks = c(-Inf,-1,-0.5,0,0.5,1,Inf)),   # If raw-delta
         move_cat = cut(w_delta_p, breaks = c(-Inf,-75,-25,0,25,75,Inf)),  # If delta-percentage
         ids_tot = n()) %>%
  group_by(move_cat,episodestartdate) %>%
  summarise(delta_distr = n(),
            ids_tot = unique(ids_tot),
            delta_perc = (delta_distr/ids_tot)*100,
            AF_distr = sum(if_else(TotAFSeconds>0,1,0)),
            AF_perc = (AF_distr/delta_distr)*100)

ggplot(plot_df_2, aes(x = episodestartdate,  y = AF_perc, color = move_cat)) + geom_point() +
    facet_grid(cols = vars(move_cat))

ggplot(plot_df_2, aes(x = delta_perc,  y = AF_perc, color = move_cat)) + geom_point() +
    facet_grid(cols = vars(move_cat)) 


```




```{r Dataset statistics}

Act_groups_th <- c(-Inf,80,142,Inf) # Quantiles
Log_Res_DF <- ActivityAF_DF %>%
  mutate(Act_group = cut(meanAct, breaks = Act_groups_th))

## DEMOGRAPHIC INFO
Demographic_info_DF <- Log_Res_DF %>%
  group_by(studyid) %>%
  slice(1) %>%
  group_by(Act_group) %>%
  filter(!is.na(studyid)) %>%
  summarise(participants = n(),
            age_m = median(age),
            age_q1 = quantile(age,1/4),
            age_q2 = quantile(age,3/4),
            female = sum(gender == "Female"), female_p = (sum(gender == "Female")/n())*100,
            CHADVASC_m = median(CHADVASC,na.rm = TRUE),
            CHADVASC_q1 = quantile(CHADVASC,1/4,na.rm = TRUE),
            CHADVASC_q2 = quantile(CHADVASC,3/4,na.rm = TRUE),
            stroke = sum(stroke,na.rm = TRUE), stroke_p = (sum(stroke)/n())*100,
            hypertension = sum(hypertension,na.rm = TRUE), hypertension_p = (sum(hypertension)/n())*100,
            diabetes = sum(diabetes,na.rm = TRUE), diabetes_p = (sum(diabetes)/n())*100,
            heart_failure = sum(heart_failure,na.rm = TRUE), heart_failure_p = (sum(heart_failure)/n())*100)

Demographic_info_DF <- baseline_info %>%
  ungroup() %>%
  summarise(countn = n(),
            agem = mean(age),
            agesd = sd(age),
            Avg_bmi = mean(bas_weight/(bas_height/100)^2,na.rm = TRUE))

Demographic_info_DF <- Log_Res_DF %>%
  group_by(studyid) %>%
  #filter(TotAFSeconds >= 60*60) %>%
  summarise(gender = unique(gender),
            bas_weight = unique(bas_weight),
            bas_height = unique(bas_height)) %>%
  ungroup %>%
  summarise(Avg_bmi = mean(bas_weight/(bas_height/100)^2,na.rm = TRUE))

## ACTIVITY INFO
Activity_info_df <- Log_Res_DF %>%
  group_by(studyid) %>%
  summarise(avg_activity = mean(ActivitiesOfDlyLiving,na.rm = T),
            days_tot = length(unique(episodestartdate))) %>%
  summarise(activitye_m = median(avg_activity),
            activity_q1 = quantile(avg_activity,1/4),
            activity_q2 = quantile(avg_activity,3/4),
            days_m = median(days_tot),
            days_q1 = quantile(days_tot,1/4),
            days_q2 = quantile(days_tot,3/4),
            ALL_days = sum(days_tot))

delta_info <- Log_Res_DF %>%
  ungroup() %>%
  summarise(delta_m = median(w_delta,na.rm=T),
            delta_q1 = quantile(w_delta,1/4,na.rm=T),
            delta_q2 = quantile(w_delta,3/4,na.rm=T))


## AF INFO
stats_AF <- ActivityAF_DF %>%
  filter(sum(DurationInSeconds)>0) %>%
  summarise(AF_events = sum(AF_id),
            AF_tot = sum(DurationInSeconds),
            oac_candidate = unique(oac_candidate))

stats2_AF <- stats_AF %>%
  ungroup() %>%
  summarise(AF_pos_p = (n()/length(unique(ActivityAF_DF$studyid)))*100,
            episodes_m = median(AF_events,na.rm = T),
            episodes_q1 = quantile(AF_events,1/4,na.rm=T),
            episodes_q2 = quantile(AF_events,3/4,na.rm=T))


stats_AF_events <- episodestrue_ED %>%
  


small_stats_df <- stats_df %>% ungroup() %>% summarise(rec_tot = sum(rec_days),
                                                       rec_m = median(rec_days),
                                                irq_days_low = quantile(rec_days,1/4),
                                                irq_days_high = quantile(rec_days,3/4),
                                                AF_pos = sum(if_else(Total_AF >0,1,0)),
                                                AF_pos_p = AF_pos/n())  




```

#### Data visualisation

```{r Logistic Regression of Windowed activity - Data visualisation}

# LOOK INTO some summaries
Log_Res_summary_DF <- Log_Res_DF %>%
  summarise(meanDiff = mean(w_delta,na.rm = TRUE),
            medianDiff = median(w_delta,na.rm = TRUE))

ggplot(Log_Res_summary_DF, aes(x = medianDiff)) +
  geom_histogram(binwidth = 0.5)


## Investigate data using a histogram
k1 <- ggplot(Log_Res_DF, aes(x = w_delta, fill = events6min)) + geom_histogram(alpha=0.6, 
                 position="identity", lwd=0.2) + xlim(c(-10,10)) +
  ggtitle("Delta-activity: W1-W2 ") + labs(fill = "AF-group")+ xlab("Delta-activity")

k2 <- ggplot(Log_Res_DF, aes(x = w_delta, fill = events6min)) +
  geom_histogram(aes(y=..density..),alpha=0.6, 
                 position="identity", lwd=0.2) + xlab("Delta-activity") +
  ggtitle("Normalized") + labs(fill = "AF-group")+ xlab("Average Activiy [s]")

grid.arrange(k1,k2,nrow = 1)

### Statistics and summary of the dataset
DF_class_imbalance <- Log_Res_DF %>%
  ungroup() %>%
  select(studyid,Min6min,Min60min,Min330min) %>%
  summarise(eventdays_6 = sum(if_else(Min6min>0,1,0)),
            unique_6 = length(unique(studyid[Min6min>0])),
            ratio_6 = sum(if_else(Min6min>0,1,0))/length(Min6min),
            eventdays_60 = sum(if_else(Min60min>0,1,0)),
            unique_60 = length(unique(studyid[Min60min>0])),
            ratio_60 = sum(if_else(Min60min>0,1,0))/length(Min60min),
            eventdays_330 = sum(if_else(Min330min>0,1,0)),
            unique_330 = length(unique(studyid[Min330min>0])),
            ratio_330 = sum(if_else(Min330min>0,1,0))/length(Min330min))
print(DF_class_imbalance)

```


```{r Scatterplots Daily activity and AF}
w_dur_lead <- 8
DF_for_plot <- ActivityAF_DF %>% group_by(studyid) %>% filter(sum(Min60min)>0) %>%
  mutate(w_dur = lead(rollapply(ActivitiesOfDlyLiving,7,mean,fill= NA,align = "right"),w_dur_lead),
             w_pre = lag(rollapply(ActivitiesOfDlyLiving,100,mean,fill= NA,align = "right"),w_pre_lag),
                w_delta = (w_pre - w_dur)/60)   # Positive delta -> decrease in activity

p1 <- ActivityAF_DF %>% group_by(episodestartdate) %>% 
  summarise(daily_act_m = mean(ActivitiesOfDlyLiving)) %>%
  ggplot(aes(x= episodestartdate, y = daily_act_m)) + geom_point() + 
  ggtitle("Activity trends in the dataset (ALL)") +
  ylab("Average activity") + xlab("Date [year]")

p2 <- ActivityAF_DF %>% group_by(episodestartdate) %>% 
  summarise(avg_AF = mean(TotAFSeconds),
            AF_events = sum(if_else(TotAFSeconds>0,1,0))/n()) %>%
  ggplot(aes(x= episodestartdate, y = AF_events)) + geom_point() + #ylim(c(0,0.2)) +
  ggtitle("AF trends in the dataset (ALL)") +
  ylab("IDs with AF [%]") + xlab("Date [year]") 

ggplot(DF_for_plot,aes(x = w_delta)) + geom_histogram(binwidth = 0.1)

p4 <- DF_for_plot %>% group_by(episodestartdate) %>% 
  summarise(avg_AF = mean(TotAFSeconds),
            AF_events = sum(if_else(TotAFSeconds>0,1,0))/n()) %>%
  ggplot(aes(x= episodestartdate, y = AF_events)) + geom_point() + #ylim(c(0,0.2)) +
  ggtitle("AF trends in the dataset (AF+)") +
  ylab("IDs with AF [%]") + xlab("Date [year]")

plot_grid(p1, p2, p3, p4, labels=c("(a)", "(b)", "(c)", "(d)"), ncol = 2, nrow = 2)


```

#### OLD CODE and analysis ####

Analysis 1) How does the pattern of AF relate to the pattern of movement - patient-ID
```{r Analysis 1 - Specific Patient, echo=TRUE, fig.keep='all'}
ID_vec = unique(episodestrue_ED["studyid"])
ID = ID_vec[4,1]

subset_df <- episodestrue_C[episodestrue_C$studyid %in% ID,]

subset_df[,"ActivitiesOfDlyLiving"] <- frollmean(subset_df[,"ActivitiesOfDlyLiving"],7) # Moving Average
subset_df[,"HeartRateVariability"] <- frollmean(subset_df[,"HeartRateVariability"],7) # Moving Average

p1 <- ggplot(subset_df, aes(x = episodestartdate, y = TotAFSeconds)) + geom_point()

p2 <- ggplot(subset_df, aes(x = episodestartdate, y = ActivitiesOfDlyLiving)) + geom_point()

#p3 <- ggplot(subset_df, aes(x = episodestartdate, y = HeartRateVariability)) + geom_point()


grid.arrange(p1, p2, nrow = 1)

```

Analysis 2) How does the pattern of AF relate to the pattern of movement - General overview

```{r Analysis 2 - General Overview}

subset_df <- episodestrue_C %>%
  select(studyid,TotAFSeconds,ActivitiesOfDlyLiving) %>%
  group_by(studyid) %>%
  summarise(Tot_AF_min = if_else(sum(TotAFSeconds)>0,"1","0"),
            avg_activity = mean(ActivitiesOfDlyLiving))

his1 <- ggplot(subset_df, aes(x = avg_activity, fill = Tot_AF_min)) +
  geom_histogram(bins = 20) +
xlab("Average Activiy [s]") +
  labs(fill = "AF-group") +
  ggtitle("Activity in AF- and Non-AF patients")

his2 <- ggplot(subset_df, aes(x = avg_activity, fill = Tot_AF_min)) +
  geom_histogram(aes(y=..density..),alpha=0.6, 
                 position="identity", lwd=0.2, bins = 20) +
  ggtitle("Normalized") + labs(fill = "AF-group")+ xlab("Average Activiy [s]")

grid.arrange(his1,his2,nrow = 1)

### Boxplot and t-test

ggplot(subset_df, aes(y = avg_activity, x = Tot_AF_min, group = Tot_AF_min)) + geom_boxplot()+
  stat_summary(fun.y=mean, geom="point", shape=20, size=4, color="red", fill="red")

t.test(subset_df$avg_activity[subset_df$Tot_AF_min==1],subset_df$avg_activity[subset_df$Tot_AF_min==0])

summary(LM_model_L <- glm(as.numeric(Tot_AF_min) ~ avg_activity
                 , data = subset_df))


```

Analysis 3) How does the pattern of AF relate to the pattern of movement - patient-ID

```{r New features based on rolling mean of activity}
### Add information from episodestrue_ED and remove uninteresting columns
AF_event_matrix <- episodestrue_ED %>% 
  group_by(studyid) %>%
  select(studyid,episodestartdate,DurationInSeconds,ActivityIndex)

### Calculate mean Activity in moving average windows, grouped by studyid
rollapply_p <- partial(rollapply,FUN = mean, fill = NA, align = "right")
Compass_AF_feat <- episodestrue_C %>%
  group_by(studyid) %>%
  mutate(act2 = rollapply_p(ActivitiesOfDlyLiving,2),
         act7 = rollapply_p(ActivitiesOfDlyLiving,7),
         act14 = rollapply_p(ActivitiesOfDlyLiving,14),
         act30 = rollapply_p(ActivitiesOfDlyLiving,30),
         act60 = rollapply_p(ActivitiesOfDlyLiving,60),
         act120 = rollapply_p(ActivitiesOfDlyLiving,120),
         act360 = rollapply_p(ActivitiesOfDlyLiving,360),
         actall = mean(ActivitiesOfDlyLiving,na.rm = TRUE))

AF_event_matrix <- left_join(AF_event_matrix,
                             Compass_AF_feat[,c("studyid","episodestartdate","act2","act7","act14","act30","act60","act120","act360","actall")],
                             by = c("studyid","episodestartdate")) %>% 
  mutate(episodedurationgroup=factor(if_else(DurationInSeconds>=60*60,"\U2265 1 hour", "< 1 hour"),
                                     levels=c("\U2265 1 hour", "< 1 hour"))
  ) %>% 
  group_by(episodedurationgroup) %>% 
  mutate(episodedurationgroup=paste0(episodedurationgroup, " , n=", n())) %>% 
  ungroup()

### Calculate r2 values

fit <- lm(AF_event_matrix$act360 ~ AF_event_matrix$act7) 
r2 <- round(summary(fit)$r.squared, 2)
### Time to Plot it
ggplot(AF_event_matrix, aes(x = act360, y = act7, fill=episodedurationgroup)) + 
  geom_point(aes(), shape=21, alpha=0.5, show.legend=F) + 
  geom_abline(colour = 'red') + 
  geom_smooth(method = "lm", show.legend=F) + 
  xlab("Avg. Activity past year prior") + 
  ylab("Avg. Activity past 7 days prior") + 
  annotate("text", x = 15, y = 400, label = paste(c("r2 = ", r2),collapse = " "))+
  facet_grid(rows = vars(episodedurationgroup))


#p2 <- ggplot(AF_event_matrix, aes(x = act360, y = act14)) + geom_point() + geom_abline(colour = 'red') + geom_smooth(method = "lm") #+ xlab("Average Activiy [s]") + ylab("Total AF in Minutes")
#p3 <- ggplot(AF_event_matrix, aes(x = act360, y = act30)) + geom_point() + geom_abline(colour = 'red') + geom_smooth(method = "lm") #+ xlab("Average Activiy [s]") + ylab("Total AF in Minutes")
#p4 <- ggplot(AF_event_matrix, aes(x = act360, y = act60)) + geom_point() + geom_abline(colour = 'red') + geom_smooth(method = "lm") #+ xlab("Average Activiy [s]") + ylab("Total AF in Minutes")

#grid.arrange(p2,p3,p4,nrow = 2)

```
Analysis 4) How does the Episode count and days with AF relate to activity, among patients with AF?

```{r Episode Count and days with AF related to activity - AF patients}
# Create subdataset with info about activity 30 days up an arrhythmia
AF_subseg <- AF_event_matrix %>%
  group_by(studyid) %>% 
  summarise(AF_count = n(),
            dayswithAF = n_distinct(episodestartdate),
            activity30days = mean(act30),
            activity30daysstd = sd(act30))

# Cathegorisation of 30-days-Arrhithmia-activity into brackets.
AF_subseg_group_info <- AF_event_matrix %>%
  mutate(activitygroup30day=cut(act30, breaks=c(0,50,100,150,200,250,300,350))) %>%
  group_by(studyid,activitygroup30day) %>%
  summarise(dayswithAF = n_distinct(episodestartdate))

# Cathegorise general info about activity and merge the two datasets
cath_activity <- Compass_AF_feat %>%
  mutate(activitygroup30day = cut(act30, breaks = c(0,50,100,150,200,250,300,350))) %>%
  group_by(studyid,activitygroup30day) %>%
  summarise(dayswithact = length(act30))
cath_activity <- left_join(AF_subseg_group_info,cath_activity, by = c("studyid","activitygroup30day")) %>%
  mutate(ratio = dayswithAF/dayswithact)

ggplot(AF_event_matrix %>% group_by(studyid, episodestartdate) %>% mutate(n=n())) + geom_histogram(aes(x = act30#, weight=1/n
                                                                                     ), color="white")

#ggplot(cath_activity) + geom_histogram(aes(x = ratio)) + facet_grid(rows = vars(activitygroup30day)) + scale_x_log10() + scale_y_log10()


ggplot(AF_event_matrix)+geom_histogram(aes(x=act30), bins=12)+
  scale_x_continuous(expand=c(0,0)) +
  xlab("Average Activiy [s]") + 
  ylab("# of AF events Total") +
  ggtitle("Avg Activity and # of AF events")


### Plot that shows the what?
#ggplot(AF_subseg_group_info, aes(x = dayswithAF, fill=activitygroup)) + 
#  geom_histogram(aes(), shape=21, alpha=0.5, show.legend=F) +
#  xlab("Activity prior 30 days") + 
#  ylab("days With AFr") +
#  facet_grid(col = vars(activitygroup))

```

```{r}

values_i <- c(7,14,30,60,120,360)
Calc_act_feat <- partial(rollapply, 
                         FUN = "mean",
                         fill = NA,
                         align = "right")


## Way too slow compared to original
act_features <- episodestrue_C %>%
  select(studyid,ActivitiesOfDlyLiving)
for (k in values_i) {
  featname <- paste("act", k, sep = "")
  act_features <- act_features %>%
    group_by(studyid) %>%
    mutate(!!featname := Calc_act_feat(ActivitiesOfDlyLiving,k))
    }

# Extract the "urls_url" elements, and flatten() the result
urls_clean <- keep(rstudioconf[[1]], "urls_url") %>%
  flatten()

# Remove the NULL
compact_urls <- urls_clean()

# Create a mapper that detects the patten "github"
has_github <- as_mapper(~ str_detect(.x, "github"))

# Look for the "github" pattern, and sum the result
map_lgl( .compact_urls, has_github ) %>%
  count()

```



```{r}




```

















